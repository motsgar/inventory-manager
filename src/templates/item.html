{% extends "layout.html" %}
{% from "popup.html" import popup_wrapper, popup_text_input, popup_number_input, popup_dropdown %}
{% from "components.html" import simple_table %}

{% block head %}
<link rel="stylesheet" href="/static/item.css" />
{% endblock %}

<!-- body -->

{% block content%}

<h1>{{ item_info.name }}</h1>

{% call simple_table("Properties", "Edit properties", "editProperties()") %}
<thead>
    <tr>
        <th>Property</th>
        <th>Value</th>
    </tr>
</thead>
<tbody class="td-padding">
    {% for property in properties %}
    <tr>
        <td>{{ property.name }}</td>
        <td>{{ property.value }}</td>
    </tr>
    {% endfor %}
</tbody>
{% endcall %}

{% call simple_table("Items", "Add item", "addItemPopup()") %}
<thead>
    <tr>
        <th>Path</th>
        <th>Count</th>
        <th class="min-width-column">Actions</th>
    </tr>
</thead>
<tbody>
    {% for location in locations %}
    <tr class="table-hover-effect">
        <td><a href="/location/{{ location.path }}">{{ location.path }}</a></td>
        <td><a href="/location/{{ location.path }}">{{ location.count }}</a></td>
        <td class="no-table-padding item-actions-column no-hover">
            <div class="flex-wrap">
                <button onclick="openEditPopup({{ location }})">Edit count</button>
                <button onclick="openMovePopup({{ location }})">Move</button>
            </div>
        </td>
    </tr>
    {% endfor %}
</tbody>
{% endcall %}

{% endblock %}

<!-- popups -->

{% block popup %}

{% call popup_wrapper("edit-properties-popup", "Edit properties", "/item/" ~ item_info.id ~ "/?action=edit") %}
{% for property in properties %}
{{ popup_text_input("item-property-" ~ property.name, "property." ~ property.name, property.name, property.value,
required = false) }}
{% endfor %}
{% endcall %}

{% call popup_wrapper("add-item-popup", "Add item", "/item/" ~ item_info.id ~ "/?action=new", "item-add-form") %}
{{ popup_dropdown("item-add-location", "location", "Location") }}
{{ popup_number_input("item-add-count", "count", "Count", "1") }}
{% endcall %}

{% call popup_wrapper("edit-item-count-popup", "Edit item count", "/item/1/1/?action=edit", "item-edit-form") %}
{{ popup_number_input("item-edit-count", "count", "Count", "0") }}
{% endcall %}

{% call popup_wrapper("move-item-location-popup", "Move items", "/item/1/1/?action=move", "item-move-form") %}
{{ popup_dropdown("item-move-location", "location", "Move location") }}
{{ popup_number_input("item-move-count", "count", "Count", "1") }}
{% endcall %}

{% endblock %}

<!-- scripts -->

{% block scripts %}
<script>
    let allLocations = null;

    function openEditPopup(itemLocation) {
        const locationEditFormElement = document.getElementById('item-edit-form');
        const itemCountElement = document.getElementById('item-edit-count');

        locationEditFormElement.setAttribute('action', `/item/{{ item_info.id }}/${itemLocation.id}/?action=edit`)

        itemCountElement.value = itemLocation.count;

        openPopup("edit-item-count-popup");
    }

    async function openMovePopup(itemLocation) {
        if (allLocations === null) {
            allLocations = await fetch(`/api/location/all`).then(res => res.json())
        }

        const locationEditFormElement = document.getElementById('item-move-form');
        const itemLocationElement = document.getElementById('item-move-location');
        const itemCountElement = document.getElementById('item-move-count');

        locationEditFormElement.setAttribute('action', `/item/{{ item_info.id }}/${itemLocation.id}/?action=move`)

        itemCountElement.value = Math.ceil(itemLocation.count / 2);
        itemCountElement.setAttribute('max', itemLocation.count)

        itemLocationElement.innerHTML = "";
        for (const location of allLocations) {
            if (location.path === itemLocation.path) continue;

            const optionElement = document.createElement('option');
            optionElement.value = location.id;
            optionElement.innerText = location.path;
            itemLocationElement.appendChild(optionElement);
        }

        openPopup("move-item-location-popup");
    }

    async function addItemPopup() {
        if (allLocations === null) {
            allLocations = await fetch(`/api/location/all`).then(res => res.json())
        }

        const itemAddFormElement = document.getElementById('item-add-form');
        const itemLocationElement = document.getElementById('item-add-location');
        const itemCountElement = document.getElementById('item-add-count');

        itemLocationElement.innerHTML = "";
        for (const location of allLocations) {
            const optionElement = document.createElement('option');
            optionElement.value = location.id;
            optionElement.innerText = location.path;
            itemLocationElement.appendChild(optionElement);
        }

        openPopup("add-item-popup");
    }

    function editProperties() {
        openPopup('edit-properties-popup');
    }
</script>
{% endblock %}